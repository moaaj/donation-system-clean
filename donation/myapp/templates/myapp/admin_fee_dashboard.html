{% extends 'base.html' %}
{% load static %}

{% block title %}Student Fee Collection Admin Dashboard{% endblock %}

{% block extra_css %}
<style>
    :root {
        --color-green: #28a745;
        --color-blue: #007bff;
        --color-purple: #6f42c1;
        --color-red: #dc3545;
        --color-orange: #fd7e14;
        --color-yellow: #ffc107;
        --color-light: #f8f9fa;
        --color-dark: #343a40;
    }
    
    body {
        background-color: #f5f6fa;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .dashboard-container {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }
    
    .page-title {
        font-size: 2rem;
        font-weight: 700;
        color: var(--color-dark);
        margin-bottom: 30px;
        text-align: center;
    }
    
    /* Main Summary Cards */
    .summary-section {
        margin-bottom: 40px;
    }
    
    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .summary-card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        text-align: center;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border-left: 5px solid;
    }
    
    .summary-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .summary-card.green { border-left-color: var(--color-green); }
    .summary-card.blue { border-left-color: var(--color-blue); }
    .summary-card.purple { border-left-color: var(--color-purple); }
    .summary-card.red { border-left-color: var(--color-red); }
    .summary-card.orange { border-left-color: var(--color-orange); }
    
    .summary-card .title {
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 10px;
        font-weight: 600;
    }
    
    .summary-card .value {
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 5px;
    }
    
    .summary-card.green .value { color: var(--color-green); }
    .summary-card.blue .value { color: var(--color-blue); }
    .summary-card.purple .value { color: var(--color-purple); }
    .summary-card.red .value { color: var(--color-red); }
    .summary-card.orange .value { color: var(--color-orange); }
    
    /* Section Headers */
    .section-header {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .section-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: var(--color-dark);
        margin-bottom: 15px;
    }
    
    /* Filter Controls */
    .filter-controls {
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .filter-group {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .filter-select {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        background: white;
        min-width: 120px;
    }
    
    /* Data Tables */
    .data-section {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }
    
    .data-table th {
        background-color: #f8f9fa;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: var(--color-dark);
        border-bottom: 2px solid #dee2e6;
    }
    
    .data-table td {
        padding: 12px;
        border-bottom: 1px solid #eee;
    }
    
    .data-table tbody tr:hover {
        background-color: #f8f9fa;
    }
    
    /* Chart Containers */
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 25px;
        margin-top: 30px;
    }
    
    .chart-container {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        text-align: center;
    }
    
    .chart-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--color-dark);
        margin-bottom: 20px;
    }
    
    .chart-canvas {
        max-height: 300px;
        width: 100%;
    }
    
    /* Fee Category Cards */
    .category-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }
    
    .category-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
    }
    
    .category-card:hover {
        transform: translateY(-3px);
    }
    
    .category-card.pta { background: linear-gradient(135deg, #007bff, #0056b3); color: white; }
    .category-card.activities { background: linear-gradient(135deg, #ffc107, #e0a800); color: white; }
    .category-card.exams { background: linear-gradient(135deg, #6f42c1, #5a2d91); color: white; }
    .category-card.dormitory { background: linear-gradient(135deg, #28a745, #1e7e34); color: white; }
    
    .category-card .amount {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 5px;
    }
    
    .category-card .achievement {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    
    /* Payment Status Cards */
    .status-cards {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin: 20px 0;
    }
    
    .status-card {
        background: white;
        border-radius: 10px;
        padding: 25px;
        text-align: center;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
    
    .status-card.paid {
        border-left: 5px solid var(--color-green);
    }
    
    .status-card.not-paid {
        border-left: 5px solid var(--color-red);
    }
    
    .status-card .number {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 5px;
    }
    
    .status-card.paid .number { color: var(--color-green); }
    .status-card.not-paid .number { color: var(--color-red); }
    
    .status-card .percentage {
        font-size: 1rem;
        color: #666;
    }
    
    /* Action Buttons */
    .action-section {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-top: 30px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .action-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }
    
    .action-btn {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 15px 20px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        text-decoration: none;
        color: white;
    }
    
    .action-btn.download {
        background: var(--color-green);
        color: white;
    }
    
    .action-btn.print {
        background: var(--color-blue);
        color: white;
    }
    
    .action-btn.reminder {
        background: var(--color-orange);
        color: white;
    }
    
    .action-btn i {
        font-size: 1.2rem;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
        .dashboard-container {
            padding: 15px;
        }
        
        .summary-cards {
            grid-template-columns: 1fr;
        }
        
        .charts-grid {
            grid-template-columns: 1fr;
        }
        
        .filter-controls {
            flex-direction: column;
            align-items: stretch;
        }
        
        .action-buttons {
            grid-template-columns: 1fr;
        }
    }
    
    /* Achievement Percentage Styling */
    .achievement-high { color: var(--color-green); font-weight: 700; }
    .achievement-medium { color: var(--color-orange); font-weight: 700; }
    .achievement-low { color: var(--color-red); font-weight: 700; }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Page Title -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="page-title mb-0">Student Fee Collection Admin Dashboard</h1>
        <div>
            <a href="{% url 'myapp:admin_fee_dashboard_pdf' %}" class="btn btn-success btn-lg">
                <i class="fas fa-file-pdf me-2"></i>Download PDF Report
            </a>
        </div>
    </div>
    
    <!-- 1. MAIN SUMMARY SECTION -->
    <div class="summary-section">
        <div class="summary-cards">
            <div class="summary-card green">
                <div class="title">üí∞ Actual Collection Amount (RM)</div>
                <div class="value">RM {{ actual_collection|floatformat:0 }}</div>
            </div>
            <div class="summary-card blue">
                <div class="title">üè´ Amount Due (RM)</div>
                <div class="value">RM {{ expected_amount|floatformat:0 }}</div>
            </div>
            <div class="summary-card purple">
                <div class="title">üìà Achievement Percentage (%)</div>
                <div class="value">{{ achievement_percentage|floatformat:1 }}%</div>
            </div>
            <div class="summary-card red">
                <div class="title">üî¥ Outstanding Amount (RM)</div>
                <div class="value">RM {{ outstanding_amount|floatformat:0 }}</div>
            </div>
            <div class="summary-card orange">
                <div class="title">üë®‚Äçüéì Total Students Registered</div>
                <div class="value">{{ total_students }}</div>
            </div>
        </div>
    </div>
    
    <!-- 2. REPORT BY FORM & CLASS SECTION -->
    <div class="data-section">
        <div class="section-header">
            <h2 class="section-title">Report by Form & Class</h2>
            <form method="GET" id="reportFilterForm" class="filter-controls">
                <div class="filter-group">
                    <label>Report by</label>
                    <select class="filter-select" name="report_by" onchange="this.form.submit()">
                        <option value="all" {% if report_by == 'all' %}selected{% endif %}>All Categories</option>
                        <option value="form" {% if report_by == 'form' %}selected{% endif %}>Form</option>
                        <option value="class" {% if report_by == 'class' %}selected{% endif %}>Class</option>
                        <option value="category" {% if report_by == 'category' %}selected{% endif %}>Fee Category</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Form</label>
                    <select class="filter-select" name="form" onchange="this.form.submit()">
                        <option value="" {% if not form_filter %}selected{% endif %}>All Forms</option>
                        <option value="1" {% if form_filter == '1' %}selected{% endif %}>Form 1</option>
                        <option value="2" {% if form_filter == '2' %}selected{% endif %}>Form 2</option>
                        <option value="3" {% if form_filter == '3' %}selected{% endif %}>Form 3</option>
                        <option value="4" {% if form_filter == '4' %}selected{% endif %}>Form 4</option>
                        <option value="5" {% if form_filter == '5' %}selected{% endif %}>Form 5</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Class</label>
                    <select class="filter-select" name="class" onchange="this.form.submit()">
                        <option value="" {% if not class_filter %}selected{% endif %}>All Classes</option>
                        <option value="A" {% if class_filter == 'A' %}selected{% endif %}>Class A</option>
                        <option value="B" {% if class_filter == 'B' %}selected{% endif %}>Class B</option>
                        <option value="C" {% if class_filter == 'C' %}selected{% endif %}>Class C</option>
                        <option value="D" {% if class_filter == 'D' %}selected{% endif %}>Class D</option>
                        <option value="E" {% if class_filter == 'E' %}selected{% endif %}>Class E</option>
                        <option value="F" {% if class_filter == 'F' %}selected{% endif %}>Class F</option>
                    </select>
                </div>
            </form>
        </div>
        
        <!-- Form & Class Data Table -->
        <table class="data-table">
            <thead>
                <tr>
                    <th>Form</th>
                    <th>Class</th>
                    <th>Male</th>
                    <th>Female</th>
                    <th>Total Students</th>
                    <th>Due (RM)</th>
                    <th>Paid (RM)</th>
                    <th>Outstanding (RM)</th>
                    <th>% Achievement</th>
                </tr>
            </thead>
            <tbody>
                {% for item in form_class_data %}
                <tr>
                    <td>{{ item.form }}</td>
                    <td>{{ item.class }}</td>
                    <td>{{ item.boys }}</td>
                    <td>{{ item.girls }}</td>
                    <td><strong>{{ item.total }}</strong></td>
                    <td>RM {{ item.expected|floatformat:0 }}</td>
                    <td>RM {{ item.paid|floatformat:0 }}</td>
                    <td>RM {{ item.outstanding|floatformat:0 }}</td>
                    <td>
                        <span class="{% if item.achieved >= 90 %}achievement-high{% elif item.achieved >= 80 %}achievement-medium{% else %}achievement-low{% endif %}">
                            {{ item.achieved }}%
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <!-- Charts for Form & Class -->
        <div class="charts-grid">
            <div class="chart-container">
                <h3 class="chart-title">Collection by Form</h3>
                <canvas id="formCollectionChart" class="chart-canvas"></canvas>
            </div>
            <div class="chart-container">
                <h3 class="chart-title">Collection by Gender</h3>
                <canvas id="genderPieChart" class="chart-canvas"></canvas>
            </div>
            <div class="chart-container">
                <h3 class="chart-title">Monthly Trend (Jan-Dec)</h3>
                <canvas id="monthlyTrendChart" class="chart-canvas"></canvas>
            </div>
        </div>
    </div>
    
    <!-- 3. REPORT BY FEE CATEGORY SECTION -->
    <div class="data-section">
        <h2 class="section-title">Report by Fee Category</h2>
        
        <!-- Category Cards -->
        <div class="category-cards">
            {% for category in fee_categories %}
            <div class="category-card {{ category.name|lower }}">
                <h4>{{ category.name }}</h4>
                <div class="amount">RM {{ category.paid|floatformat:0 }}</div>
                <div class="achievement">{{ category.achievement }}% achieved</div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Category Achievement Table -->
        <table class="data-table">
            <thead>
                <tr>
                    <th>Grade</th>
                    <th>PTA</th>
                    <th>Activities</th>
                    <th>Exams</th>
                    <th>Dormitory</th>
                    <th>Amount Due</th>
                    <th>Amount Paid</th>
                    <th>% Achievement</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>1</td>
                    <td>RM 6,200</td>
                    <td>RM 4,500</td>
                    <td>RM 5,500</td>
                    <td>RM 5,000</td>
                    <td>RM 21,200</td>
                    <td>RM 18,020</td>
                    <td><span class="achievement-high">85%</span></td>
                </tr>
                <tr>
                    <td>2</td>
                    <td>RM 5,800</td>
                    <td>RM 4,200</td>
                    <td>RM 5,200</td>
                    <td>RM 4,800</td>
                    <td>RM 20,000</td>
                    <td>RM 16,400</td>
                    <td><span class="achievement-medium">82%</span></td>
                </tr>
                <tr>
                    <td>3</td>
                    <td>RM 6,000</td>
                    <td>RM 4,300</td>
                    <td>RM 5,300</td>
                    <td>RM 4,900</td>
                    <td>RM 20,500</td>
                    <td>RM 17,835</td>
                    <td><span class="achievement-high">87%</span></td>
                </tr>
                <tr>
                    <td>4</td>
                    <td>RM 6,500</td>
                    <td>RM 4,600</td>
                    <td>RM 5,600</td>
                    <td>RM 5,200</td>
                    <td>RM 21,900</td>
                    <td>RM 19,710</td>
                    <td><span class="achievement-high">90%</span></td>
                </tr>
                <tr>
                    <td>5</td>
                    <td>RM 6,750</td>
                    <td>RM 4,800</td>
                    <td>RM 5,800</td>
                    <td>RM 5,400</td>
                    <td>RM 22,750</td>
                    <td>RM 21,613</td>
                    <td><span class="achievement-high">95%</span></td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <!-- 4. PAYMENT STATUS SECTION -->
    <div class="data-section">
        <h2 class="section-title">Status of Students Who Have Paid & Not Paid</h2>
        
        <!-- Quick Summary Cards -->
        <div class="status-cards">
            <div class="status-card paid">
                <div class="number">{{ total_paid }}</div>
                <div class="percentage">üü¢ Paid: {{ paid_percentage }}%</div>
            </div>
            <div class="status-card not-paid">
                <div class="number">{{ total_not_paid }}</div>
                <div class="percentage">üî¥ Not Paid: {{ not_paid_percentage }}%</div>
            </div>
        </div>
        
        <!-- Payment Status Table -->
        <table class="data-table">
            <thead>
                <tr>
                    <th>Grade</th>
                    <th>Class</th>
                    <th>Males Have Paid</th>
                    <th>Females Have Paid</th>
                    <th>Males Have Not Paid</th>
                    <th>Females Have Not Paid</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                {% for item in payment_status_data %}
                <tr>
                    <td>{{ item.grade }}</td>
                    <td>{{ item.class }}</td>
                    <td><span class="achievement-high">{{ item.males_paid }}</span></td>
                    <td><span class="achievement-high">{{ item.females_paid }}</span></td>
                    <td><span class="achievement-low">{{ item.males_not_paid }}</span></td>
                    <td><span class="achievement-low">{{ item.females_not_paid }}</span></td>
                    <td><strong>{{ item.total }}</strong></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <!-- Payment Status Charts -->
        <div class="charts-grid">
            <div class="chart-container">
                <h3 class="chart-title">Paid vs Not Paid by Grade</h3>
                <canvas id="paidNotPaidChart" class="chart-canvas"></canvas>
            </div>
            <div class="chart-container">
                <h3 class="chart-title">Not Paid by Gender</h3>
                <canvas id="notPaidGenderChart" class="chart-canvas"></canvas>
            </div>
        </div>
    </div>
    
    <!-- 5. ACTION SECTION -->
    <div class="action-section">
        <h2 class="section-title">Action</h2>
        <div class="action-buttons">
            <a href="{% url 'myapp:export_fee_report' %}" class="action-btn download">
                <i class="fas fa-download"></i>
                <div>
                    <div>üü¢ Download Report</div>
                    <small>(all categories) (PDF/Excel)</small>
                </div>
            </a>
            <a href="{% url 'myapp:print_receipt' %}" class="action-btn print">
                <i class="fas fa-print"></i>
                <div>
                    <div>üîµ Print Receipt / Overdue Notice</div>
                    <small>Generate printable documents</small>
                </div>
            </a>
            <a href="{% url 'myapp:send_reminder' %}" class="action-btn reminder">
                <i class="fas fa-paper-plane"></i>
                <div>
                    <div>üü† Send Parent Reminder</div>
                    <small>(SMS/WhatsApp/Email)</small>
                </div>
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Embed chart data safely -->
{{ form_collection_data|json_script:"form_collection_data" }}
{{ gender_distribution|json_script:"gender_distribution" }}
{{ monthly_trend|json_script:"monthly_trend" }}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Chart colors
    const colors = {
        blue: '#007bff',
        green: '#28a745',
        purple: '#6f42c1',
        red: '#dc3545',
        orange: '#fd7e14',
        yellow: '#ffc107'
    };
    
    // 1. Collection by Form Chart (Bar Chart)
    const formData = JSON.parse(document.getElementById('form_collection_data').textContent);
    const formCtx = document.getElementById('formCollectionChart').getContext('2d');
    new Chart(formCtx, {
        type: 'bar',
        data: {
            labels: formData.labels,
            datasets: [{
                label: 'Collection (RM)',
                data: formData.data,
                backgroundColor: [colors.blue, colors.green, colors.purple, colors.orange, colors.red],
                borderColor: [colors.blue, colors.green, colors.purple, colors.orange, colors.red],
                borderWidth: 2,
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'RM ' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
    
    // 2. Gender Distribution Chart (Pie Chart)
    const genderData = JSON.parse(document.getElementById('gender_distribution').textContent);
    const genderCtx = document.getElementById('genderPieChart').getContext('2d');
    new Chart(genderCtx, {
        type: 'pie',
        data: {
            labels: genderData.labels,
            datasets: [{
                data: genderData.data,
                backgroundColor: [colors.blue, colors.green],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
    // 3. Monthly Trend Chart (Line Chart)
    const monthlyData = JSON.parse(document.getElementById('monthly_trend').textContent);
    const monthlyCtx = document.getElementById('monthlyTrendChart').getContext('2d');
    new Chart(monthlyCtx, {
        type: 'line',
        data: {
            labels: monthlyData.labels,
            datasets: [{
                label: 'Monthly Collection',
                data: monthlyData.data,
                borderColor: colors.blue,
                backgroundColor: colors.blue + '20',
                tension: 0.4,
                fill: true,
                pointBackgroundColor: colors.blue,
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'RM ' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
    
    // 4. Paid vs Not Paid Chart (Bar Chart)
    const paidNotPaidCtx = document.getElementById('paidNotPaidChart').getContext('2d');
    new Chart(paidNotPaidCtx, {
        type: 'bar',
        data: {
            labels: ['Form 1', 'Form 2', 'Form 3', 'Form 4', 'Form 5'],
            datasets: [{
                label: 'Paid',
                data: [70, 75, 85, 90, 95],
                backgroundColor: colors.green,
                borderRadius: 4
            }, {
                label: 'Not Paid',
                data: [7, 11, 7, 10, 8],
                backgroundColor: colors.red,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { stacked: true },
                y: { stacked: true, beginAtZero: true }
            }
        }
    });
    
    // 5. Not Paid by Gender Chart (Pie Chart)
    const notPaidGenderCtx = document.getElementById('notPaidGenderChart').getContext('2d');
    new Chart(notPaidGenderCtx, {
        type: 'pie',
        data: {
            labels: ['Females', 'Males'],
            datasets: [{
                data: [55, 45],
                backgroundColor: [colors.red, colors.orange],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
});
</script>
{% endblock %}
