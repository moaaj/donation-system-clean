{% extends 'myapp/base.html' %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Donation Events</h2>
    
    <!-- Search and Filter Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form method="GET" class="row g-3">
                        <div class="col-md-4">
                            <label for="search" class="form-label">Search Events</label>
                            <input type="text" class="form-control" id="search" name="search" 
                                   value="{{ search_query }}" placeholder="Search by title, description, or category...">
                        </div>
                        <div class="col-md-3">
                            <label for="category" class="form-label">Category</label>
                            <select class="form-select" id="category" name="category">
                                <option value="">All Categories</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}" {% if category_filter == category.id|stringformat:"s" %}selected{% endif %}>
                                    {{ category.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="sort" class="form-label">Sort By</label>
                            <select class="form-select" id="sort" name="sort">
                                <option value="created_at" {% if sort_by == 'created_at' %}selected{% endif %}>Date Created</option>
                                <option value="title" {% if sort_by == 'title' %}selected{% endif %}>Title</option>
                                <option value="target_amount" {% if sort_by == 'target_amount' %}selected{% endif %}>Target Amount</option>
                                <option value="current_amount" {% if sort_by == 'current_amount' %}selected{% endif %}>Current Amount</option>
                                <option value="start_date" {% if sort_by == 'start_date' %}selected{% endif %}>Start Date</option>
                                <option value="end_date" {% if sort_by == 'end_date' %}selected{% endif %}>End Date</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="order" class="form-label">Order</label>
                            <select class="form-select" id="order" name="order">
                                <option value="desc" {% if sort_order == 'desc' %}selected{% endif %}>Descending</option>
                                <option value="asc" {% if sort_order == 'asc' %}selected{% endif %}>Ascending</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="fas fa-search"></i> Search
                            </button>
                            <a href="{% url 'myapp:donation_events' %}" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Clear
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Results Count -->
    <div class="row mb-3">
        <div class="col-12">
            <p class="text-muted">
                {% if search_query or category_filter %}
                    Found {{ events.count }} event{{ events.count|pluralize }} matching your criteria
                {% else %}
                    Showing {{ events.count }} active donation event{{ events.count|pluralize }}
                {% endif %}
            </p>
        </div>
    </div>
    
    <div class="row">
        {% for event in events %}
        <div class="col-md-4 mb-4">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">{{ event.title }}</h5>
                    <p class="card-text">{{ event.description|truncatewords:30 }}</p>
                    <div class="progress mb-3">
                        <div class="progress-bar" role="progressbar" 
                             data-width="{% widthratio event.current_amount event.target_amount 100 %}">
                        </div>
                    </div>
                    <p class="card-text">
                        <small class="text-muted">
                            RM{{ event.current_amount }} raised of RM{{ event.target_amount }} goal
                        </small>
                    </p>
                    <a href="{% url 'myapp:donation_event_detail' event.id %}" class="btn btn-primary">
                        View Details
                    </a>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="alert alert-info">
                No active donation events at the moment.
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const progressBars = document.querySelectorAll('.progress-bar');
    progressBars.forEach(bar => {
        const width = bar.getAttribute('data-width');
        bar.style.width = width + '%';
    });
    
    // Auto-submit form on filter changes
    const filterForm = document.querySelector('form');
    const filterInputs = filterForm.querySelectorAll('select');
    
    filterInputs.forEach(input => {
        input.addEventListener('change', function() {
            filterForm.submit();
        });
    });
    
    // Search input with debounce
    const searchInput = document.getElementById('search');
    let searchTimeout;
    
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(function() {
            filterForm.submit();
        }, 500); // 500ms delay
    });
    
    // Highlight search terms in results
    const searchQuery = '{{ search_query }}';
    if (searchQuery) {
        const cards = document.querySelectorAll('.card-title, .card-text');
        cards.forEach(card => {
            const text = card.innerHTML;
            const highlightedText = text.replace(
                new RegExp(searchQuery, 'gi'), 
                '<mark>$&</mark>'
            );
            card.innerHTML = highlightedText;
        });
    }
});
</script>
{% endblock %} 