{% extends 'myapp/base.html' %}

{% block title %}Pending Cash Payments{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="fas fa-clock text-warning"></i> Pending Cash Payments</h2>
                    <p class="text-muted">Confirm cash payments made by students at the school office</p>
                </div>
                <div>
                    <a href="{% url 'myapp:record_cash_payment' %}" class="btn btn-success">
                        <i class="fas fa-money-bill"></i> Record New Cash Payment
                    </a>
                    <a href="{% url 'myapp:payment_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-list"></i> All Payments
                    </a>
                </div>
            </div>
        </div>
    </div>

    {% if pending_payments or pending_donations %}
    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title">Pending Fee Payments</h5>
                            <h3 class="mb-0">{{ pending_payments.count }}</h3>
                        </div>
                        <div>
                            <i class="fas fa-file-invoice fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title">Pending Donations</h5>
                            <h3 class="mb-0">{{ pending_donations.count }}</h3>
                        </div>
                        <div>
                            <i class="fas fa-heart fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pending Fee Payments -->
    {% if pending_payments %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-file-invoice text-warning"></i> Pending Fee Payments ({{ pending_payments.count }})</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Date</th>
                                    <th>Student</th>
                                    <th>Fee Category</th>
                                    <th>Amount</th>
                                    <th>Receipt #</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for payment in pending_payments %}
                                <tr>
                                    <td>
                                        <strong>{{ payment.payment_date|date:"M d, Y" }}</strong>
                                        <br><small class="text-muted">{{ payment.created_at|date:"g:i A" }}</small>
                                    </td>
                                    <td>
                                        <strong>{{ payment.student.first_name }} {{ payment.student.last_name }}</strong>
                                        <br><small class="text-muted">{{ payment.student.student_id }}</small>
                                    </td>
                                    <td>
                                        {% if payment.fee_structure %}
                                            {{ payment.fee_structure.category.name }}
                                            <br><small class="text-muted">{{ payment.fee_structure.form }} - {{ payment.fee_structure.frequency|title }}</small>
                                        {% else %}
                                            <span class="badge bg-secondary">Individual Fee</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <strong class="text-success">RM {{ payment.amount|floatformat:2 }}</strong>
                                    </td>
                                    <td>
                                        {% if payment.receipt_number %}
                                            <code>{{ payment.receipt_number }}</code>
                                        {% else %}
                                            <small class="text-muted">Not generated</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <form method="post" style="display: inline;" onsubmit="return confirm('Are you sure you want to confirm this cash payment?');">
                                            {% csrf_token %}
                                            <input type="hidden" name="action" value="confirm_payment">
                                            <input type="hidden" name="payment_id" value="{{ payment.id }}">
                                            <button type="submit" class="btn btn-success btn-sm">
                                                <i class="fas fa-check"></i> Confirm Payment
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Pending PIBG Donations -->
    {% if pending_donations %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-heart text-info"></i> Pending PIBG Donations ({{ pending_donations.count }})</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Date</th>
                                    <th>Student</th>
                                    <th>Parent</th>
                                    <th>Amount</th>
                                    <th>Receipt #</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for donation in pending_donations %}
                                <tr>
                                    <td>
                                        <strong>{{ donation.created_at|date:"M d, Y" }}</strong>
                                        <br><small class="text-muted">{{ donation.created_at|date:"g:i A" }}</small>
                                    </td>
                                    <td>
                                        <strong>{{ donation.student.first_name }} {{ donation.student.last_name }}</strong>
                                        <br><small class="text-muted">{{ donation.student.student_id }}</small>
                                    </td>
                                    <td>
                                        {% if donation.parent %}
                                            {{ donation.parent.user.first_name }} {{ donation.parent.user.last_name }}
                                        {% else %}
                                            <span class="badge bg-secondary">Student Direct</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <strong class="text-success">RM {{ donation.amount|floatformat:2 }}</strong>
                                    </td>
                                    <td>
                                        {% if donation.receipt_number %}
                                            <code>{{ donation.receipt_number }}</code>
                                        {% else %}
                                            <small class="text-muted">Not generated</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <form method="post" style="display: inline;" onsubmit="return confirm('Are you sure you want to confirm this cash donation?');">
                                            {% csrf_token %}
                                            <input type="hidden" name="action" value="confirm_donation">
                                            <input type="hidden" name="donation_id" value="{{ donation.id }}">
                                            <button type="submit" class="btn btn-success btn-sm">
                                                <i class="fas fa-check"></i> Confirm Donation
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% else %}
    <!-- No Pending Payments -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="fas fa-check-circle fa-4x text-success mb-4"></i>
                    <h3>No Pending Cash Payments</h3>
                    <p class="text-muted">All cash payments have been processed. Great job!</p>
                    <div class="mt-4">
                        <a href="{% url 'myapp:record_cash_payment' %}" class="btn btn-success me-2">
                            <i class="fas fa-money-bill"></i> Record New Cash Payment
                        </a>
                        <a href="{% url 'myapp:payment_list' %}?payment_method=cash" class="btn btn-outline-primary">
                            <i class="fas fa-eye"></i> View All Cash Payments
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Instructions Card -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h6><i class="fas fa-info-circle"></i> How It Works</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-user-graduate text-primary"></i> Student Process:</h6>
                            <ol class="small">
                                <li>Student selects fees and chooses "Cash Payment"</li>
                                <li>Payment is marked as "pending"</li>
                                <li>Student comes to school office with cash</li>
                                <li>Admin confirms the payment here</li>
                            </ol>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-user-tie text-success"></i> Admin Process:</h6>
                            <ol class="small">
                                <li>Receive cash from student at office</li>
                                <li>Verify the amount matches the pending payment</li>
                                <li>Click "Confirm Payment" to complete the transaction</li>
                                <li>Fee status automatically updates to "paid"</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-refresh page every 30 seconds to show new pending payments
    setTimeout(function() {
        location.reload();
    }, 30000);
    
    // Add confirmation dialogs for better UX
    const confirmButtons = document.querySelectorAll('button[type="submit"]');
    confirmButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            const form = this.closest('form');
            const action = form.querySelector('input[name="action"]').value;
            const amount = this.closest('tr').querySelector('td:nth-child(4)').textContent.trim();
            const student = this.closest('tr').querySelector('td:nth-child(2) strong').textContent.trim();
            
            let message = '';
            if (action === 'confirm_payment') {
                message = `Confirm cash payment of ${amount} from ${student}?`;
            } else if (action === 'confirm_donation') {
                message = `Confirm cash donation of ${amount} from ${student}?`;
            }
            
            if (!confirm(message)) {
                e.preventDefault();
            }
        });
    });
});
</script>
{% endblock %}
