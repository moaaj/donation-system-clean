{% extends 'base.html' %}
{% load static %}

{% block title %}Students{% endblock %}

{% block content %}
<div class="container-fluid">
    {% if is_public %}
    <div class="alert alert-info alert-dismissible fade show" role="alert">
        {% if is_school_fees %}
        <strong>üè´ School Fees Demo Version</strong> - This is a test version with limited data (first 20 students). 
        For full access, please <a href="{% url 'myapp:student_list' %}" class="alert-link">login here</a>.
        {% else %}
        <strong>üîç Public Demo Version</strong> - This is a test version with limited data (first 20 students). 
        For full access, please <a href="{% url 'myapp:student_list' %}" class="alert-link">login here</a>.
        {% endif %}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <h1>Students <span class="badge bg-primary">{{ total_students }}</span>
                {% if is_public %}
                    {% if is_school_fees %}
                        <span class="badge bg-info ms-2">School Fees Demo</span>
                    {% else %}
                        <span class="badge bg-warning ms-2">Public Demo</span>
                    {% endif %}
                {% endif %}
            </h1>
            <div>
                {% if user.is_authenticated %}
                <a href="{% url 'myapp:bulk_add_students_form' %}" class="btn btn-success me-2">
                    <i class="fas fa-users"></i> Bulk Add Students
                </a>
                <a href="{% url 'myapp:add_student' %}" class="btn btn-primary me-2">
                    <i class="fas fa-user-plus"></i> Add Student
                </a>
                {% endif %}
                {% if user.is_superuser %}
                <a href="{% url 'myapp:download_all_students_pdf' %}?{% if search_query %}search={{ search_query }}&{% endif %}{% if show != 'active' %}show={{ show }}&{% endif %}{% if sort_by != 'first_name' %}sort={{ sort_by }}&{% endif %}{% if sort_order != 'asc' %}order={{ sort_order }}{% endif %}" class="btn btn-danger me-2" title="Download filtered students information in PDF format">
                    <i class="fas fa-file-pdf"></i> Download PDF
                </a>
                {% endif %}
                <div class="btn-group ms-2">
                    <a href="{% url 'myapp:student_list' %}?show=active" class="btn btn-outline-primary {% if show != 'all' %}active{% endif %}">
                        Active Students
                    </a>
                    <a href="{% url 'myapp:student_list' %}?show=all" class="btn btn-outline-primary {% if show == 'all' %}active{% endif %}">
                        All Students
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form method="GET" class="row g-3" id="searchForm">
                        <!-- Search Input -->
                        <div class="col-md-4">
                            <label for="search" class="form-label">Search Students</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control" id="search" name="search" 
                                       value="{{ search_query }}" placeholder="Search by name, ID, NRIC, level, or batch...">
                            </div>
                        </div>
                        
                        <!-- Sort By -->
                        <div class="col-md-3">
                            <label for="sort" class="form-label">Sort By</label>
                            <select class="form-select" id="sort" name="sort">
                                <option value="first_name" {% if sort_by == 'first_name' %}selected{% endif %}>First Name</option>
                                <option value="last_name" {% if sort_by == 'last_name' %}selected{% endif %}>Last Name</option>
                                <option value="student_id" {% if sort_by == 'student_id' %}selected{% endif %}>Student ID</option>
                                <option value="level_custom" {% if sort_by == 'level_custom' %}selected{% endif %}>Level</option>
                                <option value="year_batch" {% if sort_by == 'year_batch' %}selected{% endif %}>Year Batch</option>
                                <option value="is_active" {% if sort_by == 'is_active' %}selected{% endif %}>Status</option>
                                <option value="created_at" {% if sort_by == 'created_at' %}selected{% endif %}>Date Added</option>
                            </select>
                        </div>
                        
                        <!-- Sort Order -->
                        <div class="col-md-2">
                            <label for="order" class="form-label">Order</label>
                            <select class="form-select" id="order" name="order">
                                <option value="asc" {% if sort_order == 'asc' %}selected{% endif %}>Ascending</option>
                                <option value="desc" {% if sort_order == 'desc' %}selected{% endif %}>Descending</option>
                            </select>
                        </div>
                        
                        <!-- Show Filter -->
                        <div class="col-md-2">
                            <label for="show" class="form-label">Show</label>
                            <select class="form-select" id="show" name="show">
                                <option value="active" {% if show == 'active' %}selected{% endif %}>Active Only</option>
                                <option value="all" {% if show == 'all' %}selected{% endif %}>All Students</option>
                            </select>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="col-md-1 d-flex align-items-end">
                            <div class="btn-group w-100">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search"></i>
                                </button>
                                <a href="{% url 'myapp:student_list' %}" class="btn btn-outline-secondary" title="Clear Filters">
                                    <i class="fas fa-times"></i>
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>
                                        <a href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if show != 'active' %}show={{ show }}&{% endif %}sort=student_id&order={% if sort_by == 'student_id' and sort_order == 'asc' %}desc{% else %}asc{% endif %}" 
                                           class="text-white text-decoration-none">
                                            Student ID
                                            {% if sort_by == 'student_id' %}
                                                <i class="fas fa-sort-{% if sort_order == 'asc' %}up{% else %}down{% endif %}"></i>
                                            {% endif %}
                                        </a>
                                    </th>
                                    <th>
                                        <a href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if show != 'active' %}show={{ show }}&{% endif %}sort=first_name&order={% if sort_by == 'first_name' and sort_order == 'asc' %}desc{% else %}asc{% endif %}" 
                                           class="text-white text-decoration-none">
                                            Name
                                            {% if sort_by == 'first_name' %}
                                                <i class="fas fa-sort-{% if sort_order == 'asc' %}up{% else %}down{% endif %}"></i>
                                            {% endif %}
                                        </a>
                                    </th>
                                    <th>
                                        <a href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if show != 'active' %}show={{ show }}&{% endif %}sort=nric&order={% if sort_by == 'nric' and sort_order == 'asc' %}desc{% else %}asc{% endif %}" 
                                           class="text-white text-decoration-none">
                                            NRIC
                                            {% if sort_by == 'nric' %}
                                                <i class="fas fa-sort-{% if sort_order == 'asc' %}up{% else %}down{% endif %}"></i>
                                            {% endif %}
                                        </a>
                                    </th>
                                    <th>
                                        <a href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if show != 'active' %}show={{ show }}&{% endif %}sort=phone_number&order={% if sort_by == 'phone_number' and sort_order == 'asc' %}desc{% else %}asc{% endif %}" 
                                           class="text-white text-decoration-none">
                                            Phone Number
                                            {% if sort_by == 'phone_number' %}
                                                <i class="fas fa-sort-{% if sort_order == 'asc' %}up{% else %}down{% endif %}"></i>
                                            {% endif %}
                                        </a>
                                    </th>
                                    <th>
                                        <a href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if show != 'active' %}show={{ show }}&{% endif %}sort=level_custom&order={% if sort_by == 'level_custom' and sort_order == 'asc' %}desc{% else %}asc{% endif %}" 
                                           class="text-white text-decoration-none">
                                            Level
                                            {% if sort_by == 'level_custom' %}
                                                <i class="fas fa-sort-{% if sort_order == 'asc' %}up{% else %}down{% endif %}"></i>
                                            {% endif %}
                                        </a>
                                    </th>
                                    <th>
                                        <a href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if show != 'active' %}show={{ show }}&{% endif %}sort=year_batch&order={% if sort_by == 'year_batch' and sort_order == 'asc' %}desc{% else %}asc{% endif %}" 
                                           class="text-white text-decoration-none">
                                            Year Batch
                                            {% if sort_by == 'year_batch' %}
                                                <i class="fas fa-sort-{% if sort_order == 'asc' %}up{% else %}down{% endif %}"></i>
                                            {% endif %}
                                        </a>
                                    </th>
                                    <th>
                                        <a href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if show != 'active' %}show={{ show }}&{% endif %}sort=is_active&order={% if sort_by == 'is_active' and sort_order == 'asc' %}desc{% else %}asc{% endif %}" 
                                           class="text-white text-decoration-none">
                                            Status
                                            {% if sort_by == 'is_active' %}
                                                <i class="fas fa-sort-{% if sort_order == 'asc' %}up{% else %}down{% endif %}"></i>
                                            {% endif %}
                                        </a>
                                    </th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for student in students %}

                                <tr>
                                    <td>{{ student.student_id }}</td>
                                    <td>{{ student.first_name }} {{ student.last_name }}</td>
                                    <td>{{ student.nric }}</td>
                                    <td>{{ student.phone_number|default:"-" }}</td>
                                    <td>
                                        {% if student.level == 'form' and student.level_custom %}
                                            <span class="badge bg-primary">{{ student.level_custom }}</span>
                                        {% elif student.level == 'others' and student.level_custom %}
                                            <span class="badge bg-secondary">{{ student.level_custom }}</span>
                                        {% else %}
                                            {{ student.get_level_display_value|default:"-" }}
                                        {% endif %}
                                    </td>
                                    <td>{{ student.year_batch }}</td>
                                    <td>
                                        <span class="badge {% if student.is_active %}bg-success{% else %}bg-danger{% endif %}">
                                            {{ student.is_active|yesno:'Active,Dropped' }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if user.is_authenticated %}
                                        <a href="{% url 'myapp:student_detail' student.id %}" class="btn btn-sm btn-info" onclick="console.log('Eye button clicked for student:', '{{ student.id }}')">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="{% url 'myapp:edit_student' student.id %}" class="btn btn-sm btn-warning" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{% url 'myapp:delete_student' student.id %}" class="btn btn-sm btn-danger" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                        {% else %}
                                        <span class="text-muted">
                                            <i class="fas fa-lock"></i> Login required
                                        </span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center">
                                        {% if search_query %}
                                            <div class="text-muted">
                                                <i class="fas fa-search fa-2x mb-2"></i>
                                                <p>No students found matching "{{ search_query }}"</p>
                                                <a href="{% url 'myapp:student_list' %}" class="btn btn-outline-primary">Clear Search</a>
                                            </div>
                                        {% else %}
                                            <div class="text-muted">
                                                <i class="fas fa-users fa-2x mb-2"></i>
                                                <p>No students found</p>
                                            </div>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Results Summary -->
                    {% if students %}
                    <div class="mt-3">
                        <small class="text-muted">
                            Showing {{ students.start_index }} - {{ students.end_index }} of {{ total_students }} students
                            {% if search_query %}matching "{{ search_query }}"{% endif %}
                            {% if sort_by != 'first_name' %}sorted by {{ sort_by|title }}{% endif %}
                        </small>
                    </div>
                    {% endif %}
                    
                    <!-- Pagination Controls -->
                    {% if students.has_other_pages %}
                    <nav aria-label="Students pagination" class="mt-4">
                        <ul class="pagination justify-content-center">
                            <!-- First Page -->
                            {% if students.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if show != 'active' %}show={{ show }}&{% endif %}{% if sort_by != 'first_name' %}sort={{ sort_by }}&{% endif %}{% if sort_order != 'asc' %}order={{ sort_order }}&{% endif %}page=1" aria-label="First">
                                    <span aria-hidden="true">&laquo;&laquo;</span>
                                </a>
                            </li>
                            {% endif %}
                            
                            <!-- Previous Page -->
                            {% if students.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if show != 'active' %}show={{ show }}&{% endif %}{% if sort_by != 'first_name' %}sort={{ sort_by }}&{% endif %}{% if sort_order != 'asc' %}order={{ sort_order }}&{% endif %}page={{ students.previous_page_number }}" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link" aria-hidden="true">&laquo;</span>
                            </li>
                            {% endif %}
                            
                            <!-- Page Numbers -->
                            {% for num in students.paginator.page_range %}
                                {% if num == students.number %}
                                <li class="page-item active">
                                    <span class="page-link">{{ num }}</span>
                                </li>
                                {% elif num > students.number|add:'-3' and num < students.number|add:'3' %}
                                <li class="page-item">
                                    <a class="page-link" href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if show != 'active' %}show={{ show }}&{% endif %}{% if sort_by != 'first_name' %}sort={{ sort_by }}&{% endif %}{% if sort_order != 'asc' %}order={{ sort_order }}&{% endif %}page={{ num }}">{{ num }}</a>
                                </li>
                                {% elif num == 1 or num == students.paginator.num_pages %}
                                <li class="page-item">
                                    <a class="page-link" href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if show != 'active' %}show={{ show }}&{% endif %}{% if sort_by != 'first_name' %}sort={{ sort_by }}&{% endif %}{% if sort_order != 'asc' %}order={{ sort_order }}&{% endif %}page={{ num }}">{{ num }}</a>
                                </li>
                                {% elif num == 2 and students.number > 5 %}
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                                {% elif num == students.paginator.num_pages|add:'-1' and students.number < students.paginator.num_pages|add:'-4' %}
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                                {% endif %}
                            {% endfor %}
                            
                            <!-- Next Page -->
                            {% if students.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if show != 'active' %}show={{ show }}&{% endif %}{% if sort_by != 'first_name' %}sort={{ sort_by }}&{% endif %}{% if sort_order != 'asc' %}order={{ sort_order }}&{% endif %}page={{ students.next_page_number }}" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link" aria-hidden="true">&raquo;</span>
                            </li>
                            {% endif %}
                            
                            <!-- Last Page -->
                            {% if students.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if show != 'active' %}show={{ show }}&{% endif %}{% if sort_by != 'first_name' %}sort={{ sort_by }}&{% endif %}{% if sort_order != 'asc' %}order={{ sort_order }}&{% endif %}page={{ students.paginator.num_pages }}" aria-label="Last">
                                    <span aria-hidden="true">&raquo;&raquo;</span>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    
                    <!-- Page Info -->
                    <div class="text-center mt-2">
                        <small class="text-muted">
                            Page {{ students.number }} of {{ students.paginator.num_pages }}
                        </small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for enhanced UX -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Student list page loaded');
    
    // Get form and elements with error handling
    const form = document.getElementById('searchForm') || document.querySelector('form');
    const sortSelect = document.getElementById('sort');
    const orderSelect = document.getElementById('order');
    const showSelect = document.getElementById('show');
    const searchInput = document.getElementById('search');
    
    if (!form) {
        console.error('Search form not found');
        return;
    }
    
    console.log('Form found:', form);
    
    // Auto-submit form on dropdown changes
    [sortSelect, orderSelect, showSelect].forEach(select => {
        if (select) {
            select.addEventListener('change', function() {
                console.log('Dropdown changed, submitting form');
                try {
                    form.submit();
                } catch (error) {
                    console.error('Error submitting form:', error);
                    // Fallback: reload page with parameters
                    window.location.href = form.action + '?' + new URLSearchParams(new FormData(form)).toString();
                }
            });
        }
    });
    
    // Search input with debounce
    if (searchInput) {
        let searchTimeout;
        
        searchInput.addEventListener('input', function() {
            console.log('Search input changed:', this.value);
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(function() {
                console.log('Submitting search form');
                try {
                    form.submit();
                } catch (error) {
                    console.error('Error submitting search:', error);
                    // Fallback: reload page with search parameter
                    const searchValue = searchInput.value;
                    const url = new URL(window.location);
                    if (searchValue) {
                        url.searchParams.set('search', searchValue);
                    } else {
                        url.searchParams.delete('search');
                    }
                    window.location.href = url.toString();
                }
            }, 500); // Submit after 500ms of no typing
        });
        
        // Also handle Enter key
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                console.log('Enter key pressed, submitting form');
                clearTimeout(searchTimeout);
                try {
                    form.submit();
                } catch (error) {
                    console.error('Error submitting on Enter:', error);
                    const searchValue = searchInput.value;
                    const url = new URL(window.location);
                    if (searchValue) {
                        url.searchParams.set('search', searchValue);
                    } else {
                        url.searchParams.delete('search');
                    }
                    window.location.href = url.toString();
                }
            }
        });
    }
    
    // Clear search button
    const clearButton = document.querySelector('a[title="Clear Filters"]');
    if (clearButton) {
        clearButton.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Clear button clicked');
            window.location.href = "{% url 'myapp:student_list' %}";
        });
    }
    
    // Manual search button
    const searchButton = document.querySelector('button[type="submit"]');
    if (searchButton) {
        searchButton.addEventListener('click', function(e) {
            console.log('Search button clicked');
            // Let the form submit naturally
        });
    }
    
    // Highlight search terms in results
    const searchQuery = "{{ search_query|escapejs }}";
    if (searchQuery) {
        console.log('Highlighting search terms:', searchQuery);
        const rows = document.querySelectorAll('tbody tr');
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            if (text.includes(searchQuery.toLowerCase())) {
                row.style.backgroundColor = '#fff3cd';
            }
        });
    }
    
    console.log('Student list JavaScript initialization complete');
});
</script>
{% endblock %} 