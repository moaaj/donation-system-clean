{% extends 'base.html' %}
{% load static %}

{% block title %}User Activity Dashboard - Superuser Only{% endblock %}

{% block extra_css %}
<style>
    .dashboard-container {
        padding: 20px;
        background: #f8f9fa;
        min-height: 100vh;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border-left: 4px solid #007bff;
    }
    
    .stat-card.success { border-left-color: #28a745; }
    .stat-card.warning { border-left-color: #ffc107; }
    .stat-card.danger { border-left-color: #dc3545; }
    .stat-card.info { border-left-color: #17a2b8; }
    
    .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
        color: #333;
        margin-bottom: 5px;
    }
    
    .stat-label {
        color: #666;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .content-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .chart-container {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .activity-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .activity-table th,
    .activity-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #eee;
    }
    
    .activity-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #333;
    }
    
    .badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .badge-success { background: #d4edda; color: #155724; }
    .badge-secondary { background: #e2e3e5; color: #383d41; }
    .badge-danger { background: #f8d7da; color: #721c24; }
    

    
    .section-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #007bff;
    }
    
    .ip-address {
        font-family: monospace;
        background: #f8f9fa;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.85rem;
    }
    
    .timestamp {
        color: #666;
        font-size: 0.85rem;
    }
    
    .superuser-banner {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        text-align: center;
    }
    
    .tamim123-highlight {
        background-color: #e3f2fd !important;
        border-left: 4px solid #2196f3 !important;
    }
    
    @media (max-width: 768px) {
        .content-grid {
            grid-template-columns: 1fr;
        }
        
        .stats-grid {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Superuser Banner -->
    <div class="superuser-banner">
        <h1 style="margin: 0; font-size: 1.8rem;">
            <i class="fas fa-shield-alt"></i> Superuser Activity Dashboard
        </h1>
        <p style="margin: 5px 0 0 0; opacity: 0.9;">
            Welcome, {{ request.user.username }}! Here's the complete user activity overview.
            <br><small>Last updated: {{ current_time|date:"M d, Y H:i:s" }}</small>
        </p>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-grid">
        <div class="stat-card success">
            <div class="stat-number">{{ total_logins }}</div>
            <div class="stat-label">Total Logins</div>
        </div>
        <div class="stat-card info">
            <div class="stat-number">{{ total_logouts }}</div>
            <div class="stat-label">Total Logouts</div>
        </div>
        <div class="stat-card warning">
            <div class="stat-number">{{ today_logins }}</div>
            <div class="stat-label">Today's Logins</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ today_users }}</div>
            <div class="stat-label">Active Users Today</div>
        </div>
        <div class="stat-card success">
            <div class="stat-number">{{ successful_logins }}</div>
            <div class="stat-label">Successful Logins</div>
        </div>
        <div class="stat-card danger">
            <div class="stat-number">{{ failed_logins }}</div>
            <div class="stat-label">Failed Login Attempts</div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="content-grid">
        <!-- Left Column -->
        <div>
            <!-- Recent User Activity -->
            <div class="chart-container">
                <h3 class="section-title">
                    <i class="fas fa-history"></i> Recent User Activity (Last 30)
                </h3>
                {% if recent_activities %}
                    <div class="table-responsive">
                        <table class="activity-table">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Activity</th>
                                    <th>IP Address</th>
                                    <th>Time</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for activity in recent_activities %}
                                <tr {% if activity.user.username == 'tamim123' %}class="tamim123-highlight"{% endif %}>
                                    <td>
                                        <strong>{{ activity.user.username }}</strong>
                                        {% if activity.user.username == 'tamim123' %}
                                            <span style="color: #2196f3; font-size: 0.8rem;">(Featured)</span>
                                        {% endif %}
                                        {% if activity.user.first_name or activity.user.last_name %}
                                            <br><small style="color: #666;">
                                                {{ activity.user.first_name }} {{ activity.user.last_name }}
                                            </small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if activity.activity_type == 'login' %}
                                            <span class="badge badge-success">Login</span>
                                        {% else %}
                                            <span class="badge badge-secondary">Logout</span>
                                        {% endif %}
                                    </td>
                                    <td><span class="ip-address">{{ activity.ip_address }}</span></td>
                                    <td class="timestamp">{{ activity.timestamp|date:"M d, H:i:s" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p style="color: #666; text-align: center; padding: 20px;">No recent activity found.</p>
                {% endif %}
            </div>



            <!-- All Users Activity Table -->
            <div class="chart-container">
                <h3 class="section-title">
                    <i class="fas fa-users"></i> All Users Activity Summary
                </h3>
                {% if all_users_activity %}
                    <div class="table-responsive">
                        <table class="activity-table">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Total Activities</th>
                                    <th>Logins</th>
                                    <th>Logouts</th>
                                    <th>Last Activity</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in all_users_activity %}
                                <tr {% if user.user__username == 'tamim123' %}class="tamim123-highlight"{% endif %}>
                                    <td>
                                        <strong>{{ user.user__username }}</strong>
                                        {% if user.user__username == 'tamim123' %}
                                            <span style="color: #2196f3; font-size: 0.8rem;">(Featured User)</span>
                                        {% endif %}
                                        {% if user.user__first_name or user.user__last_name %}
                                            <br><small style="color: #666;">
                                                {{ user.user__first_name }} {{ user.user__last_name }}
                                            </small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span style="font-weight: bold; color: #007bff;">{{ user.total_activities }}</span>
                                    </td>
                                    <td>
                                        <span style="color: #28a745;">{{ user.login_count }}</span>
                                    </td>
                                    <td>
                                        <span style="color: #6c757d;">{{ user.logout_count }}</span>
                                    </td>
                                    <td class="timestamp">
                                        {{ user.last_activity|date:"M d, H:i" }}
                                    </td>
                                    <td>
                                        {% if user.last_activity %}
                                            {% if user.last_activity|date:"Y-m-d" == current_time|date:"Y-m-d" %}
                                                <span class="badge badge-success">Active Today</span>
                                            {% else %}
                                                <span class="badge badge-secondary">Recent</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge badge-danger">No Activity</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p style="color: #666; text-align: center; padding: 20px;">No user activity data available.</p>
                {% endif %}
            </div>
        </div>

        <!-- Right Column -->
        <div>
            <!-- Tamim123 Specific Activity -->
            {% if tamim123_stats.total_activities > 0 %}
            <div class="chart-container">
                <h3 class="section-title">
                    <i class="fas fa-user-check"></i> Tamim123 Activity Details
                </h3>
                <div style="background: #e3f2fd; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #2196f3;">{{ tamim123_stats.total_activities }}</div>
                            <div style="font-size: 0.8rem; color: #666;">Total Activities</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #28a745;">{{ tamim123_stats.logins }}</div>
                            <div style="font-size: 0.8rem; color: #666;">Logins</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #6c757d;">{{ tamim123_stats.logouts }}</div>
                            <div style="font-size: 0.8rem; color: #666;">Logouts</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #ffc107;">{{ tamim123_stats.today_activities }}</div>
                            <div style="font-size: 0.8rem; color: #666;">Today</div>
                        </div>
                    </div>
                </div>
                {% if tamim123_activities %}
                    <h4 style="margin-bottom: 10px; color: #333;">Recent Activities:</h4>
                    {% for activity in tamim123_activities %}
                    <div style="padding: 8px; border-bottom: 1px solid #eee; margin-bottom: 5px;">
                        <div style="font-size: 0.85rem;">
                            <span style="font-weight: 600;">{{ activity.get_activity_type_display }}</span>
                            <span style="color: #666;">at {{ activity.timestamp|date:"M d, H:i:s" }}</span>
                            <br><span class="ip-address">{{ activity.ip_address }}</span>
                        </div>
                    </div>
                    {% endfor %}
                {% endif %}
            </div>
            {% endif %}

            <!-- Top Active Users -->
            <div class="chart-container">
                <h3 class="section-title">
                    <i class="fas fa-star"></i> Top Active Users
                </h3>
                {% if top_users %}
                    {% for user in top_users %}
                    <div style="padding: 10px; border-bottom: 1px solid #eee; margin-bottom: 10px;">
                        <div style="font-weight: 600;">
                            {{ user.user__username }}
                            {% if user.user__username == 'tamim123' %}
                                <span style="color: #2196f3; font-size: 0.8rem;">(Featured)</span>
                            {% endif %}
                        </div>
                        <div style="font-size: 0.85rem; color: #666;">
                            {{ user.user__first_name }} {{ user.user__last_name }}
                            <br><strong>{{ user.activity_count }}</strong> total activities
                            <br><span style="color: #28a745;">{{ user.login_count }}</span> logins, <span style="color: #6c757d;">{{ user.logout_count }}</span> logouts
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p style="color: #666; text-align: center; padding: 20px;">No user activity data.</p>
                {% endif %}
            </div>

            <!-- Failed Login Attempts -->
            <div class="chart-container">
                <h3 class="section-title">
                    <i class="fas fa-exclamation-triangle"></i> Recent Failed Logins
                </h3>
                {% if recent_failed_logins %}
                    {% for attempt in recent_failed_logins %}
                    <div style="padding: 10px; border-bottom: 1px solid #eee; margin-bottom: 10px;">
                        <div style="font-weight: 600; color: #dc3545;">
                            {{ attempt.user.username|default:"Unknown User" }}
                        </div>
                        <div style="font-size: 0.85rem; color: #666;">
                            <span class="ip-address">{{ attempt.ip_address }}</span>
                            <br>{{ attempt.timestamp|date:"M d, H:i" }}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p style="color: #666; text-align: center; padding: 20px;">No failed login attempts.</p>
                {% endif %}
            </div>

            <!-- IP Address Analysis -->
            <div class="chart-container">
                <h3 class="section-title">
                    <i class="fas fa-network-wired"></i> Top IP Addresses
                </h3>
                {% if top_ips %}
                    {% for ip in top_ips %}
                    <div style="padding: 10px; border-bottom: 1px solid #eee; margin-bottom: 10px;">
                        <div style="font-weight: 600;">
                            <span class="ip-address">{{ ip.ip_address }}</span>
                        </div>
                        <div style="font-size: 0.85rem; color: #666;">
                            <strong>{{ ip.count }}</strong> activities
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p style="color: #666; text-align: center; padding: 20px;">No IP data available.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>


{% endblock %}
