{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                    <h2 class="text-center mb-0">
                        <i class="fas fa-archive me-2"></i>Archived Waqaf Assets
                    </h2>
                    <div>
                        <a href="{% url 'waqaf:waqaf' %}" class="btn btn-primary">
                            <i class="fas fa-arrow-left me-2"></i>Back to Assets
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    {% csrf_token %}
                    <div class="text-center mb-4">
                        <i class="fas fa-archive fa-4x text-warning mb-3"></i>
                        <p class="lead">View and manage archived waqaf assets</p>
                        <p class="text-muted">Total archived assets: {{ total_archived }}</p>
                    </div>

                    {% if archived_assets %}
                        <div class="row g-4">
                            {% for asset in archived_assets %}
                            <div class="col-md-6 col-lg-4">
                                <div class="card h-100 border-warning">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h5 class="card-title mb-0 text-muted">{{ asset.name }}</h5>
                                            <span class="badge bg-warning text-dark">Archived</span>
                                        </div>
                                        
                                        <p class="card-text text-muted">{{ asset.description|truncatewords:20 }}</p>
                                        
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="text-primary fw-bold">RM {{ asset.target_amount|floatformat:2 }}</span>
                                                <span class="text-muted small">{{ asset.slots_available }}/{{ asset.total_slots }} slots</span>
                                            </div>
                                            <div class="progress mb-2">
                                                <div class="progress-bar bg-warning" role="progressbar" 
                                                     style="width: {{ asset.progress_percent|default:0 }}%">
                                                    {{ asset.progress_percent|default:0|floatformat:0 }}%
                                                </div>
                                            </div>
                                            <small class="text-muted">
                                                Archived on: {{ asset.archived_at|date:"M d, Y" }}
                                            </small>
                                            {% if asset.archived_by %}
                                            <br><small class="text-muted">
                                                By: {{ asset.archived_by.get_full_name|default:asset.archived_by.username }}
                                            </small>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="row text-center mb-3">
                                            <div class="col-6">
                                                <small class="text-muted">Contributions</small><br>
                                                <strong>{{ asset.get_contribution_count }}</strong>
                                            </div>
                                            <div class="col-6">
                                                <small class="text-muted">Slot Price</small><br>
                                                <strong>RM {{ asset.slot_price|floatformat:2 }}</strong>
                                            </div>
                                        </div>
                                        
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-success btn-sm flex-fill unarchive-asset-btn" 
                                                    data-asset-id="{{ asset.id }}" 
                                                    data-asset-name="{{ asset.name }}">
                                                <i class="fas fa-undo me-2"></i>Unarchive
                                            </button>
                                            <a href="{% url 'waqaf:delete_waqaf_asset' asset.id %}" 
                                               class="btn btn-danger btn-sm flex-fill"
                                               onclick="return confirm('Are you sure you want to permanently delete this archived asset?')">
                                                <i class="fas fa-trash me-2"></i>Delete
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-archive fa-3x text-muted mb-3"></i>
                            <h4 class="text-muted">No Archived Assets</h4>
                            <p class="text-muted">There are currently no archived waqaf assets.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Unarchive functionality
document.addEventListener('DOMContentLoaded', function() {
    // Handle unarchive asset buttons
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('unarchive-asset-btn') || e.target.closest('.unarchive-asset-btn')) {
            e.preventDefault();
            
            const btn = e.target.classList.contains('unarchive-asset-btn') ? e.target : e.target.closest('.unarchive-asset-btn');
            const assetId = btn.dataset.assetId;
            const assetName = btn.dataset.assetName;
            
            if (confirm(`Are you sure you want to unarchive "${assetName}"? This will make it visible to the public again.`)) {
                unarchiveAsset(assetId, assetName);
            }
        }
    });
    
    // Unarchive asset function
    function unarchiveAsset(assetId, assetName) {
        fetch(`{% url 'waqaf:unarchive_asset' 0 %}`.replace('0', assetId), {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage(`Successfully unarchived "${assetName}"`, 'success');
                // Reload the page to reflect changes
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                showMessage(data.message || 'Failed to unarchive asset', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('An error occurred while unarchiving the asset', 'error');
        });
    }
    
    // Show message function
    function showMessage(message, type) {
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const alert = document.createElement('div');
        alert.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
        alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(alert);
        
        // Auto-dismiss after 3 seconds
        setTimeout(() => {
            alert.remove();
        }, 3000);
    }
});
</script>
{% endblock %}
