{% extends 'myapp/base_ubac.html' %}
{% load myapp_filters %}

{% block title %}School Fees - Student View{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-money-bill-wave"></i> My School Fees - Student Portal</h2>
            <div>
                <a href="{% url 'myapp:student_payment_history' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-history"></i> Payment History
                </a>
                <a href="{% url 'myapp:view_cart' %}" class="btn btn-success ms-2">
                    <i class="fas fa-shopping-cart"></i> View Cart
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Student Welcome Message -->
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-info">
            <h5><i class="fas fa-info-circle"></i> Student Payment Portal</h5>
            <p class="mb-0">Welcome to your personal fee payment portal. Here you can view your outstanding fees, add them to your cart, and make payments. Use the "Add to Cart" buttons to select fees for payment, then proceed to checkout.</p>
        </div>
    </div>
</div>

    <!-- Student Information Card -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-user-graduate"></i> Student Information</h5>
                </div>
                <div class="card-body">
                    <p><strong>Name:</strong> {{ student.first_name }} {{ student.last_name }}</p>
                    <p><strong>Student ID:</strong> {{ student.student_id }}</p>
                    <p><strong>Year Batch:</strong> {{ student.year_batch }}</p>
                    <p><strong>Status:</strong> 
                        {% if student.is_active %}
                            <span class="badge bg-success">Active</span>
                        {% else %}
                            <span class="badge bg-danger">Inactive</span>
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-pie"></i> Payment Summary</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <h4 class="text-primary">{{ total_payments }}</h4>
                            <p class="text-muted">Total Payments</p>
                        </div>
                        <!-- Removed Total Paid section -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Individual Student Fees -->
    {% if individual_fees %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5><i class="fas fa-user-clock"></i> Your Individual Fees</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Fee Name</th>
                                    <th>Category</th>
                                    <th>Description</th>
                                    <th>Amount</th>
                                    <th>Due Date</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for fee in individual_fees %}
                                <tr>
                                    <td><strong>{{ fee.name }}</strong></td>
                                    <td>{{ fee.category.name }}</td>
                                    <td>{{ fee.description }}</td>
                                    <td>RM {{ fee.amount|floatformat:2 }}</td>
                                    <td>{{ fee.due_date|date:"d M Y" }}</td>
                                    <td>
                                        {% if fee.is_paid %}
                                            <span class="badge bg-success">Paid</span>
                                        {% elif fee.is_overdue %}
                                            <span class="badge bg-danger">Overdue</span>
                                        {% else %}
                                            <span class="badge bg-warning">Pending</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if not fee.is_paid %}
                                        <form method="post" action="{% url 'myapp:add_to_cart' %}" style="display:inline;">
                                            {% csrf_token %}
                                            <input type="hidden" name="individual_fee_id" value="{{ fee.id }}">
                                            <input type="hidden" name="next" value="{% url 'myapp:view_cart' %}">
                                            <button type="submit" class="btn btn-sm btn-warning">
                                                <i class="fas fa-cart-plus"></i> Add to Cart
                                            </button>
                                        </form>
                                        {% else %}
                                        <button class="btn btn-sm btn-success" disabled>
                                            <i class="fas fa-check"></i> Paid
                                        </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Fee Statuses with Discounts -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-list"></i> Your Fees</h5>
                </div>
                <div class="card-body">
                    {% if fee_statuses %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Due Date</th>
                                    <th>Original Amount</th>
                                    <th>Discount</th>
                                    <th>Amount to Pay</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for fee_status in fee_statuses %}
                                <tr>
                                    <td>{{ fee_status.fee_structure.category.name }}</td>
                                    <td>{{ fee_status.due_date|date:"d M Y" }}</td>
                                    <td>
                                        {% if fee_status.discount_info.has_discount %}
                                            <span class="text-decoration-line-through text-muted">RM {{ fee_status.discount_info.original_amount|floatformat:2 }}</span>
                                        {% else %}
                                            RM {{ fee_status.amount|floatformat:2 }}
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if fee_status.discount_info.has_discount %}
                                            <span class="badge bg-success">
                                                -RM {{ fee_status.discount_info.total_discount|floatformat:2 }}
                                            </span>
                                            {% if fee_status.discount_info.waivers %}
                                                <br><small class="text-muted">
                                                    {% for waiver in fee_status.discount_info.waivers %}
                                                        {{ waiver.type }}{% if not forloop.last %}, {% endif %}
                                                    {% endfor %}
                                                </small>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <strong class="text-primary">RM {{ fee_status.discount_info.discounted_amount|floatformat:2 }}</strong>
                                    </td>
                                    <td>
                                        {% if fee_status.status == 'paid' %}
                                            <span class="badge bg-success">Paid</span>
                                        {% elif fee_status.status == 'overdue' %}
                                            <span class="badge bg-danger">Overdue</span>
                                        {% else %}
                                            <span class="badge bg-warning">Pending</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if fee_status.status == 'paid' %}
                                            <button class="btn btn-sm btn-success" disabled>
                                                <i class="fas fa-check"></i> Paid
                                            </button>
                                        {% else %}
                                            <form method="post" action="{% url 'myapp:add_to_cart' %}" style="display:inline;">
                                                {% csrf_token %}
                                                <input type="hidden" name="fee_status_id" value="{{ fee_status.id }}">
                                                <input type="hidden" name="next" value="{% url 'myapp:view_cart' %}">
                                                <button type="submit" class="btn btn-sm btn-warning">
                                                    <i class="fas fa-cart-plus"></i> Add to Cart
                                                </button>
                                            </form>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-info-circle fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No fees available at the moment.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
{% endblock %} 